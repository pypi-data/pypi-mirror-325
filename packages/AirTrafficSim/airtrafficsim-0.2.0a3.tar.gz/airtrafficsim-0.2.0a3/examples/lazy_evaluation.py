# ruff: noqa: E501
"""Support for lazy evaluation via polars DataFrame"""

import polars as pl

# import airtrafficsim
# x = pl.DataFrame({"alpha": [2, 3, 4, 5]})
# def sq(x: pl.Expr):
#     an = x.__array_namespace__()
#     print(an.exp(x))
#     return x
# print(x.select(sq(pl.col("alpha"))))
# raise SystemExit
import numpy as np
from airtrafficsim.performance.bada3 import atmosphere


def calc_atmosphere(z: pl.Expr) -> tuple[pl.Expr, pl.Expr, pl.Expr]:
    res = atmosphere(z, delta_temperature=0.0)
    return (
        z,
        res.pressure.alias("pressure"),
        res.temperature.alias("temperature"),
    )


DATA = {
    "z": np.linspace(0, 20000, 50),
    # ... more data
}

lf = pl.DataFrame(DATA).lazy()
query = lf.select(calc_atmosphere(pl.col("z")))
# print(query.explain(format="tree"))
print(query.explain())
"""
             0                                                       1                                                                     2                                              3                                                   4                                       5
   ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   │
   │     ╭────────╮
 0 │     │ SELECT │
   │     ╰───┬┬───╯
   │         ││
   │         │╰──────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────╮
   │         │                                                       │                                                                     │                                              │
   │         │         ╭─────────────────────────────────────────────┴─────────────────────────────────────────────╮                       │                                              │
   │         │         │ expression:                                                                               │                       │                                              │
   │  ╭──────┴──────╮  │ when(col("__POLARS_CSER_0xe1959db22a752850"))                                             │  ╭────────────────────┴────────────────────╮                  ╭──────┴───────╮
   │  │ expression: │  │   .then([(101325.0) * ([([(col("__POLARS_CSER_0x634a69620790210c")) - (0.0)]) / (288.15)] │  │ expression:                             │                  │ FROM:        │
 1 │  │ col("z")    │  │   .pow([dyn float: 5.25588]))])                                                           │  │ col("__POLARS_CSER_0x634a69620790210c") │                  │ WITH_COLUMNS │
   │  ╰─────────────╯  │   .otherwise([(22632.06) * ([([(col("z")) - (11000.0)]) * (-0.000158)]                    │  │   .alias("temperature")                 │                  ╰──────┬┬──────╯
   │                   │   .exp())])                                                                               │  ╰─────────────────────────────────────────╯                         ││
   │                   │   .alias("pressure")                                                                      │                                                                      ││
   │                   ╰───────────────────────────────────────────────────────────────────────────────────────────╯                                                                      ││
   │                                                                                                                                                                                      ││
   │                                                                                                                                                                                      │╰──────────────────────────────────────────────────┬───────────────────────────────────────╮
   │                                                                                                                                                                                      │                                                   │                                       │
   │                                                                                                                                                                                      │                          ╭────────────────────────┴─────────────────────────╮             │
   │                                                                                                                                                               ╭──────────────────────┴───────────────────────╮  │ expression:                                      │  ╭──────────┴──────────╮
   │                                                                                                                                                               │ expression:                                  │  │ when([(col("z")) <= (11000.0)])                  │  │ DF ["z"]            │
 2 │                                                                                                                                                               │ [(col("z")) <= (11000.0)]                    │  │   .then([(288.15) + ([(col("z")) * (-0.0065)])]) │  │ PROJECT 1/1 COLUMNS │
   │                                                                                                                                                               │   .alias("__POLARS_CSER_0xe1959db22a752850") │  │   .otherwise(216.65)                             │  ╰─────────────────────╯
   │                                                                                                                                                               ╰──────────────────────────────────────────────╯  │   .alias("__POLARS_CSER_0x634a69620790210c")     │
   │                                                                                                                                                                                                                 ╰──────────────────────────────────────────────────╯
"""
print(query.collect())
"""
shape: (50, 3)
┌──────────────┬──────────────┬─────────────┐
│ z            ┆ pressure     ┆ temperature │
│ ---          ┆ ---          ┆ ---         │
│ f64          ┆ f64          ┆ f64         │
╞══════════════╪══════════════╪═════════════╡
│ 0.0          ┆ 101325.0     ┆ 288.15      │
│ 408.163265   ┆ 96516.787991 ┆ 285.496939  │
│ 816.326531   ┆ 91895.021614 ┆ 282.843878  │
│ 1224.489796  ┆ 87454.118816 ┆ 280.190816  │
│ 1632.653061  ┆ 83188.614413 ┆ 277.537755  │
│ …            ┆ …            ┆ …           │
│ 18367.346939 ┆ 7082.460919  ┆ 216.65      │
│ 18775.510204 ┆ 6640.974885  ┆ 216.65      │
│ 19183.673469 ┆ 6227.008934  ┆ 216.65      │
│ 19591.836735 ┆ 5838.8476    ┆ 216.65      │
│ 20000.0      ┆ 5474.882348  ┆ 216.65      │
└──────────────┴──────────────┴─────────────┘
"""
