/*! For license information please see 824.774a3eb055417f4225d1.js.LICENSE.txt */
"use strict";(self.webpackChunk_jupyterlite_terminal=self.webpackChunk_jupyterlite_terminal||[]).push([[824],{824:(t,e,s)=>{s.r(e),s.d(e,{Aliases:()=>r,BufferedOutput:()=>V,CommandRegistry:()=>P,ConsoleOutput:()=>H,Context:()=>F,ControlCharacter:()=>xt,ExitCode:()=>n,FileInput:()=>$,FileOutput:()=>Q,InputAll:()=>U,InputFlag:()=>vt,LocalFlag:()=>It,OutputFlag:()=>Tt,Pipe:()=>z,PipeInput:()=>j,RedirectOutput:()=>X,Shell:()=>Bt,TerminalInput:()=>G,TerminalOutput:()=>K,Termios:()=>Rt,parse:()=>rt,tokenize:()=>Y});var i={};s.r(i),s.d(i,{AliasCommand:()=>p,BuiltinCommand:()=>h,CdCommand:()=>m,ClearCommand:()=>I,CockleConfigCommand:()=>R,ExitCommand:()=>L,ExportCommand:()=>M,HistoryCommand:()=>W});class r extends Map{constructor(){super()}getRecursive(t){let e=this.get(t);for(;void 0!==e;){const s=e.split(" ")[0];if(s===t)break;const i=this.get(s);if(void 0===i)return e;e=i+e.slice(s.length),t=s}return e}match(t){return[...this.keys()].filter((e=>e.startsWith(t)))}}const n={SUCCESS:0,GENERAL_ERROR:1,IMPROPER_USE:2,CANNOT_RUN_COMMAND:126,CANNOT_FIND_COMMAND:127};class a extends Error{exitCode;constructor(t,e){super(e),this.exitCode=t}}class o extends a{constructor(t){super(n.CANNOT_FIND_COMMAND,`'${t}': command not found`)}}class l extends a{constructor(t){super(n.GENERAL_ERROR,t)}}class h{names(){return[this.name]}run(t,e){if(t!==this.name)throw new o(t);return this._run(e)}}class c{shortName;longName;description;constructor(t,e,s){this.shortName=t,this.longName=e,this.description=s}get isSet(){return this._isSet}get name(){return this.shortName?this.shortName:this.longName}get prefixedName(){return this.shortName?`-${this.shortName}`:`--${this.longName}`}set(){this._isSet=!0}_isSet=!1}class u extends c{constructor(t,e,s){super(t,e,s)}}class d extends c{minCount;constructor(t=1){if(super("","",""),this.minCount=t,t<0)throw new l("Negative minCount in TrailingStringsOption.constructor")}add(t){this._strings.push(t),this._isSet=!0}get length(){return this._strings.length}get strings(){return this._strings}_strings=[]}class f{static fromArgs(t,e){const s=new e,i=s._getStrings();let r=!1;for(const e of t)if(e.startsWith("-")&&e.length>1){if(r)throw new l("Cannot have named option after parsing a trailing path");if(e.startsWith("--")){const t=e.slice(2);s._findByLongName(t).set()}else{const t=e.slice(1);s._findByShortName(t).set()}}else{if(null===i)throw new l(`Unrecognised option: ${e}`);i.add(e),r=!0}if(i&&i.length<i.minCount)throw new l("Insufficient trailing strings options specified");return s}writeHelp(t){for(const e of this._help())t.write(`${e}\n`)}_findByLongName(t){let e;for(e of Object.values(this))if(e.longName===t)return e;throw new l(`No such longName option '${t}'`)}_findByShortName(t){let e;for(e of Object.values(this))if(e.shortName===t)return e;throw new l(`No such shortName option '${t}'`)}_getStrings(){return"trailingStrings"in this?this.trailingStrings:null}_help(){return[...Object.values(this)].sort(((t,e)=>t.name>e.name?1:-1)).map((t=>{const e=t.prefixedName,s=Math.max(1,12-e.length);return`    ${e}${" ".repeat(s)}${t.description}`}))}}class _ extends f{trailingStrings=new d(0)}class p extends h{get name(){return"alias"}async _run(t){const{aliases:e,args:s,stdout:i}=t,r=f.fromArgs(s,_);if(r.trailingStrings.isSet)for(const t of r.trailingStrings.strings){const s=t.indexOf("=");-1===s?i.write(`${t}='${e.get(t)}'\n`):e.set(t.slice(0,s),t.slice(s+1))}else for(const[t,s]of e.entries())i.write(`${t}='${s}'\n`);return n.SUCCESS}}class g extends f{trailingStrings=new d(0)}class m extends h{get name(){return"cd"}async _run(t){const{args:e}=t,s=f.fromArgs(e,g).trailingStrings.strings;if(s.length<1)return n.SUCCESS;if(s.length>1)throw new l("cd: too many arguments");let i=s[0];if("-"===i){const e=t.environment.get("OLDPWD");if(void 0===e)throw new l("cd: OLDPWD not set");i=e,t.stdout.write(`${i}\n`)}const{FS:r}=t.fileSystem,a=r.cwd();return r.chdir(i),t.environment.set("OLDPWD",a),t.environment.set("PWD",r.cwd()),n.SUCCESS}}const C="[",w=(t=1)=>t>0?C+t+"D":"",y="[H",S="[2J",E="[3J",A="[K",b="[1;0m",O="[0;94m",N="[0;95m",k="[0;32m",v="[?25h",T="[?25l";class I extends h{get name(){return"clear"}async _run(t){const{stdout:e}=t;return e.supportsAnsiEscapes()&&e.write(S+E+y),n.SUCCESS}}function*x(t,e,s=!1,i=null){const r=t.length,n=t[0].length,a=t.map((t=>t.map((t=>t.length)))),o=Array(n).fill(0);for(let t=0;t<r;t++)for(let e=0;e<n;e++)o[e]=Math.max(o[e],a[t][e]);function l(t){let e="â•­â”œâ•°"[t];for(let s=0;s<n;s++)e+="â”€".repeat(o[s]+2),e+=s<n-1?"â”¬â”¼â”´"[t]:"â•®â”¤â•¯"[t];return e}s||(yield l(0));for(let a=0;a<r;a++){const h=t[a];let c=s?"":"â”‚ ";for(let t=0;t<n;t++){const e=i?.get(t)||null;c+=e?e+h[t]+b:h[t],c+=" ".repeat(o[t]-h[t].length),c+=s?"  ":" â”‚ "}if(yield c,a===e-1)if(s){let t="";for(let e=0;e<n;e++)t+="â”€".repeat(o[e])+"  ";yield t}else a!==r-1&&(yield l(1))}s||(yield l(2))}class R extends h{get name(){return"cockle-config"}async _run(t){const{stdout:e}=t;return e.write("cockle 0.0.15\n"),this._writePackageConfig(t),this._writeModuleConfig(t),n.SUCCESS}_writeModuleConfig(t){const{commandRegistry:e,stdout:s,wasmModuleCache:i}=t,r=e.allModules(),n=[["module","package","cached"]];for(const t of r)n.push([t.name,t.packageName,i.has(t.packageName,t.name)?"yes":""]);let a=null;s.supportsAnsiEscapes()&&(a=new Map,a.set(1,O),a.set(2,N));for(const t of x(n,1,!1,a))s.write(t+"\n")}_writePackageConfig(t){const{commandRegistry:e,stdout:s}=t,i=e.wasmPackageMap,r=[["package","version","build string","channel"]];for(const t of i.values())r.push([t.name,t.version,t.build_string,t.channel]);let n=null;s.supportsAnsiEscapes()&&(n=new Map,n.set(1,O),n.set(2,N),n.set(3,k));for(const t of x(r,1,!1,n))s.write(t+"\n")}}class L extends h{get name(){return"exit"}async _run(t){const{stdout:e,terminate:s}=t;return e.write("Terminating shell...\n"),e.flush(),s(),n.SUCCESS}}class D extends f{trailingStrings=new d(0)}class M extends h{get name(){return"export"}async _run(t){const{args:e,environment:s}=t,i=f.fromArgs(e,D);if(i.trailingStrings.isSet)for(const t of i.trailingStrings.strings){const e=t.indexOf("=");if(e>0){const i=t.slice(0,e),r=t.slice(e+1);s.set(i,r)}}return n.SUCCESS}}class B extends f{clear=new u("c","","clear the history by deleting all of the entries");help=new u("","help","display this help and exit")}class W extends h{get name(){return"history"}async _run(t){const{args:e,history:s,stdout:i}=t,r=f.fromArgs(e,B);return r.help.isSet?r.writeHelp(i):r.clear.isSet?s.clear():s.write(i),n.SUCCESS}}class P{constructor(){this.registerBuiltinCommands(i)}allModules(){const t=[];for(const e of this.wasmPackageMap.values())t.push(...e.modules);return t.sort(((t,e)=>t.name<e.name?-1:1)),t}get(t){return this._map.get(t)??null}match(t){return[...this._map.keys()].filter((e=>e.startsWith(t))).sort()}registerBuiltinCommands(t){for(const[e,s]of Object.entries(t))if(e.endsWith("Command")&&!e.startsWith("Builtin"))try{const t=new s;t instanceof h&&this._register(t)}catch{}}registerWasmCommandPackage(t){this.wasmPackageMap.set(t.name,t);for(const e of t.modules)this._register(e)}_register(t){for(const e of t.names())this._map.set(e,t)}_map=new Map;wasmPackageMap=new Map}class F{args;fileSystem;mountpoint;aliases;commandRegistry;environment;history;terminate;stdin;stdout;stderr;bufferedIO;wasmModuleCache;constructor(t,e,s,i,r,n,a,o,l,h,c,u,d){this.args=t,this.fileSystem=e,this.mountpoint=s,this.aliases=i,this.commandRegistry=r,this.environment=n,this.history=a,this.terminate=o,this.stdin=l,this.stdout=h,this.stderr=c,this.bufferedIO=u,this.wasmModuleCache=d}flush(){this.stderr.flush(),this.stdout.flush()}}class V{get allContent(){return this.data.join("")}clear(){this.data=[]}supportsAnsiEscapes(){return!1}write(t){this.data.push(t)}data=[]}class H{flush(){}supportsAnsiEscapes(){return!1}write(t){console.log(t)}}class U{isTerminal(){return!1}readChar(){if(void 0===this._buffer&&(this._buffer=this.readAll(),this._index=0),this._index<this._buffer.length){const t=this._buffer[this._index++],e=[];for(let s=0;s<t.length;s++)e.push(t.charCodeAt(s));return e}return[4]}_buffer;_index=0}class $ extends U{fileSystem;path;constructor(t,e){super(),this.fileSystem=t,this.path=e}readAll(){const{FS:t}=this.fileSystem;return t.readFile(this.path,{encoding:"utf8"})}}class Q extends V{fileSystem;path;append;constructor(t,e,s){super(),this.fileSystem=t,this.path=e,this.append=s}flush(){const{FS:t}=this.fileSystem;let e=this.allContent;if(this.append)try{e=t.readFile(this.path,{encoding:"utf8"})+e}catch(t){}t.writeFile(this.path,e,{mode:436}),this.clear()}}class j extends U{pipe;constructor(t){super(),this.pipe=t}readAll(){const t=this.pipe.allContent;return this.pipe.clear(),t}}class z extends V{flush(){}get input(){return new j(this)}}class X extends V{constructor(t){super(),this.target=t}flush(){this.data.forEach((t=>this.target.write(t))),this.clear(),this.target.flush()}target}class G{stdinCallback;constructor(t){this.stdinCallback=t}isTerminal(){return!0}readChar(){if(this._finished||void 0===this.stdinCallback)return[4];{const t=this.stdinCallback();if(4===t[0])this._finished=!0;else if(13===t[0])return[10];return t}}_finished=!1}class K{outputCallback;prefix;suffix;constructor(t,e=null,s=null){this.outputCallback=t,this.prefix=e,this.suffix=s}flush(){}supportsAnsiEscapes(){return!0}write(t){t.length<1||(null!==this.prefix&&(t=this.prefix+t),null!==this.suffix&&(t+=this.suffix),this.outputCallback(t))}}function Y(t,e=!0,s){const i=new q(t,e,s);return i.run(),i.tokens}var J;!function(t){t[t.None=0]="None",t[t.Delimiter=1]="Delimiter",t[t.DoubleQuote=2]="DoubleQuote",t[t.SingleQuote=3]="SingleQuote",t[t.Whitespace=4]="Whitespace",t[t.Other=5]="Other"}(J||(J={}));class q{throwErrors;aliases;constructor(t,e,s){this.throwErrors=e,this.aliases=s,this._source=t,this._tokens=[]}run(){for(;this._index<=this._source.length;)this._next();if(this.throwErrors&&""!==this._endQuote)throw new l("Tokenize error, expected end quote "+this._endQuote)}get tokens(){return this._tokens}_addToken(){const t=this._offset,e=this._value;if(void 0!==this.aliases&&t!==this._aliasOffset&&(0===this._tokens.length||";&|".includes(this._tokens.at(-1).value.at(-1)))){const s=this.aliases.getRecursive(e);if(void 0!==s){const i=e.length;return this._offset=-1,this._index=t-1,this._aliasOffset=t,this._source=this._source.slice(0,t)+s+this._source.slice(t+i),this._prevChar="",this._prevCharType=J.None,this._value="",this._endQuote="",!1}}return this._tokens.push({offset:t,value:e}),this._endQuote="",!0}_getCharType(t){return" ".includes(t)?J.Whitespace:";&|><".includes(t)?J.Delimiter:"'"===t?J.SingleQuote:'"'===t?J.DoubleQuote:J.Other}_endQuoteFromCharType(t){return t===J.DoubleQuote?'"':t===J.SingleQuote?"'":""}_next(){const t=++this._index,e=t<this._source.length?this._source[t]:" ";let s=this._getCharType(e);const i=this._endQuoteFromCharType(s);this._offset>=0?this._endQuote?e!==this._endQuote?this._value+=e:(this._endQuote="",s=J.Other):i?this._endQuote=i:s===J.Whitespace?this._addToken()&&(this._offset=-1):s!==this._prevCharType||s===J.Delimiter&&e!==this._prevChar?this._addToken()&&(this._offset=t,this._value=e):this._value+=e:s!==J.Whitespace&&(this._offset=t,this._endQuote=this._endQuoteFromCharType(s),this._value=""===this._endQuote?e:""),this._prevChar=e,this._prevCharType=s}_source;_tokens;_prevChar="";_prevCharType=J.None;_index=-1;_offset=-1;_aliasOffset=-1;_value="";_endQuote=""}const Z=";&";class tt{}class et extends tt{name;suffix;redirects;constructor(t,e,s){super(),this.name=t,this.suffix=e,this.redirects=s}lastToken(){return this.redirects&&this.redirects.length>0?this.redirects[this.redirects.length-1].lastToken():this.suffix.length>0?[this.suffix[this.suffix.length-1],!1]:[this.name,!0]}}class st extends tt{commands;constructor(t){super(),this.commands=t}lastToken(){return this.commands.length>0?this.commands[this.commands.length-1].lastToken():[null,!1]}}class it extends tt{token;target;constructor(t,e){super(),this.token=t,this.target=e}lastToken(){return[this.target,!1]}}function rt(t,e=!0,s){const i=Y(t,e,s),r=[],n=[];let a=-1;const o=i.length;function l(){1===n.length?r.push(n[0]):n.length>1&&r.push(new st([...n])),n.length=0}for(let t=0;t<o;t++){const e=i[t];a>=0?Z.includes(e.value)?(n.push(nt(i.slice(a,t))),l(),a=-1):"|"===e.value&&(n.push(nt(i.slice(a,t))),a=-1):Z.includes(e.value)||(a=t)}return a>=0&&n.push(nt(i.slice(a,o))),l(),r}function nt(t){let e=t.slice(1);const s=e.findIndex((t=>{return(e=t.value).startsWith(">")||e.startsWith("<");var e}));if(s>=0){if(e.length!==s+2)throw new l("Redirect should be followed by file to redirect to");const i=new it(e[s],e[s+1]);return e=e.slice(0,s),new et(t[0],e,[i])}return new et(t[0],e)}var at=s(602);const ot=Symbol("Comlink.proxy"),lt=Symbol("Comlink.endpoint"),ht=Symbol("Comlink.releaseProxy"),ct=Symbol("Comlink.finalizer"),ut=Symbol("Comlink.thrown"),dt=t=>"object"==typeof t&&null!==t||"function"==typeof t,ft=new Map([["proxy",{canHandle:t=>dt(t)&&t[ot],serialize(t){const{port1:e,port2:s}=new MessageChannel;return _t(t,e),[s,[s]]},deserialize:t=>(t.start(),gt(t))}],["throw",{canHandle:t=>dt(t)&&ut in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function _t(t,e=globalThis,s=["*"]){e.addEventListener("message",(function i(r){if(!r||!r.data)return;if(!function(t,e){for(const s of t){if(e===s||"*"===s)return!0;if(s instanceof RegExp&&s.test(e))return!0}return!1}(s,r.origin))return void console.warn(`Invalid origin '${r.origin}' for comlink proxy`);const{id:n,type:a,path:o}=Object.assign({path:[]},r.data),l=(r.data.argumentList||[]).map(Nt);let h;try{const e=o.slice(0,-1).reduce(((t,e)=>t[e]),t),s=o.reduce(((t,e)=>t[e]),t);switch(a){case"GET":h=s;break;case"SET":e[o.slice(-1)[0]]=Nt(r.data.value),h=!0;break;case"APPLY":h=s.apply(e,l);break;case"CONSTRUCT":h=bt(new s(...l));break;case"ENDPOINT":{const{port1:e,port2:s}=new MessageChannel;_t(t,s),h=function(t,e){return At.set(t,e),t}(e,[e])}break;case"RELEASE":h=void 0;break;default:return}}catch(t){h={value:t,[ut]:0}}Promise.resolve(h).catch((t=>({value:t,[ut]:0}))).then((s=>{const[r,o]=Ot(s);e.postMessage(Object.assign(Object.assign({},r),{id:n}),o),"RELEASE"===a&&(e.removeEventListener("message",i),pt(e),ct in t&&"function"==typeof t[ct]&&t[ct]())})).catch((t=>{const[s,i]=Ot({value:new TypeError("Unserializable return value"),[ut]:0});e.postMessage(Object.assign(Object.assign({},s),{id:n}),i)}))})),e.start&&e.start()}function pt(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function gt(t,e){const s=new Map;return t.addEventListener("message",(function(t){const{data:e}=t;if(!e||!e.id)return;const i=s.get(e.id);if(i)try{i(e)}finally{s.delete(e.id)}})),St(t,s,[],e)}function mt(t){if(t)throw new Error("Proxy has been released and is not useable")}function Ct(t){return kt(t,new Map,{type:"RELEASE"}).then((()=>{pt(t)}))}const wt=new WeakMap,yt="FinalizationRegistry"in globalThis&&new FinalizationRegistry((t=>{const e=(wt.get(t)||0)-1;wt.set(t,e),0===e&&Ct(t)}));function St(t,e,s=[],i=function(){}){let r=!1;const n=new Proxy(i,{get(i,a){if(mt(r),a===ht)return()=>{!function(t){yt&&yt.unregister(t)}(n),Ct(t),e.clear(),r=!0};if("then"===a){if(0===s.length)return{then:()=>n};const i=kt(t,e,{type:"GET",path:s.map((t=>t.toString()))}).then(Nt);return i.then.bind(i)}return St(t,e,[...s,a])},set(i,n,a){mt(r);const[o,l]=Ot(a);return kt(t,e,{type:"SET",path:[...s,n].map((t=>t.toString())),value:o},l).then(Nt)},apply(i,n,a){mt(r);const o=s[s.length-1];if(o===lt)return kt(t,e,{type:"ENDPOINT"}).then(Nt);if("bind"===o)return St(t,e,s.slice(0,-1));const[l,h]=Et(a);return kt(t,e,{type:"APPLY",path:s.map((t=>t.toString())),argumentList:l},h).then(Nt)},construct(i,n){mt(r);const[a,o]=Et(n);return kt(t,e,{type:"CONSTRUCT",path:s.map((t=>t.toString())),argumentList:a},o).then(Nt)}});return function(t,e){const s=(wt.get(e)||0)+1;wt.set(e,s),yt&&yt.register(t,e,t)}(n,t),n}function Et(t){const e=t.map(Ot);return[e.map((t=>t[0])),(s=e.map((t=>t[1])),Array.prototype.concat.apply([],s))];var s}const At=new WeakMap;function bt(t){return Object.assign(t,{[ot]:!0})}function Ot(t){for(const[e,s]of ft)if(s.canHandle(t)){const[i,r]=s.serialize(t);return[{type:"HANDLER",name:e,value:i},r]}return[{type:"RAW",value:t},At.get(t)||[]]}function Nt(t){switch(t.type){case"HANDLER":return ft.get(t.name).deserialize(t.value);case"RAW":return t.value}}function kt(t,e,s,i){return new Promise((r=>{const n=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.set(n,r),t.start&&t.start(),t.postMessage(Object.assign({id:n},s),i)}))}var vt,Tt,It,xt;!function(t){t[t.ISTRIP=32]="ISTRIP",t[t.INLCR=64]="INLCR",t[t.IGNCR=128]="IGNCR",t[t.ICRNL=256]="ICRNL",t[t.IUCLC=512]="IUCLC",t[t.IXON=1024]="IXON",t[t.IXANY=2048]="IXANY",t[t.IMAXBEL=8192]="IMAXBEL",t[t.IUTF8=16384]="IUTF8"}(vt||(vt={})),function(t){t[t.OPOST=1]="OPOST",t[t.OLCUC=2]="OLCUC",t[t.ONLCR=4]="ONLCR",t[t.OCRNL=8]="OCRNL",t[t.ONOCR=16]="ONOCR",t[t.ONLRET=32]="ONLRET",t[t.TABDLY=6144]="TABDLY"}(Tt||(Tt={})),function(t){t[t.ISIG=1]="ISIG",t[t.ICANON=2]="ICANON",t[t.ECHO=8]="ECHO",t[t.ECHOE=16]="ECHOE",t[t.ECHOK=32]="ECHOK",t[t.ECHONL=64]="ECHONL",t[t.NOFLSH=128]="NOFLSH",t[t.ECHOCTL=512]="ECHOCTL",t[t.ECHOPRT=1024]="ECHOPRT",t[t.ECHOKE=2048]="ECHOKE",t[t.IEXTEN=32768]="IEXTEN"}(It||(It={})),function(t){t[t.VINTR=0]="VINTR",t[t.VQUIT=1]="VQUIT",t[t.VERASE=2]="VERASE",t[t.VKILL=3]="VKILL",t[t.VEOF=4]="VEOF",t[t.VTIME=5]="VTIME",t[t.VMIN=6]="VMIN",t[t.VSWTCH=7]="VSWTCH",t[t.VSTART=8]="VSTART",t[t.VSTOP=9]="VSTOP",t[t.VSUSP=10]="VSUSP",t[t.VEOL=11]="VEOL",t[t.VREPRINT=12]="VREPRINT",t[t.VDISCARD=13]="VDISCARD",t[t.VWERASE=14]="VWERASE",t[t.VLNEXT=15]="VLNEXT",t[t.VEOL2=16]="VEOL2"}(xt||(xt={}));class Rt{clone(){return{c_iflag:this.c_iflag,c_oflag:this.c_oflag,c_cflag:this.c_cflag,c_lflag:this.c_lflag,c_cc:[...this.c_cc]}}log(t){const e=(t,e,s)=>{const i=[];for(const[e,r]of Object.entries(t).filter((([t,e])=>t[0].match(/\D/))))(s&r)>0&&i.push(e);return`  ${e} = ${s} 0x${s.toString(16)} = ${i.join(" ")}`},s=[t+":"];s.push(e(vt,"c_iflag",this.c_iflag)),s.push(e(Tt,"c_oflag",this.c_oflag)),s.push(`  c_cflag = ${this.c_cflag} 0x${this.c_cflag.toString(16)}`),s.push(e(It,"c_lflag",this.c_lflag)),s.push(`  c_cc = ${this.c_cc}`),console.log(s.join("\n"))}static newDefaultWasm(){const t=new Rt;return t.setDefaultWasm(),t}set(t){this.c_iflag=t.c_iflag,this.c_oflag=t.c_oflag,this.c_cflag=t.c_cflag,this.c_lflag=t.c_lflag,this.c_cc=[...t.c_cc],this.log("Termios set")}setDefaultWasm(){this.c_iflag=vt.IUTF8|vt.IMAXBEL|vt.IXON|vt.ICRNL,this.c_oflag=Tt.OPOST|Tt.ONLCR,this.c_cflag=191,this.c_lflag=It.IEXTEN|It.ECHOKE|It.ECHOCTL|It.ECHOK|It.ECHOE|It.ECHO|It.ICANON|It.ISIG,this.c_cc=[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.log("Termios setDefaultWasm")}c_iflag=0;c_oflag=0;c_cflag=0;c_lflag=0;c_cc=[]}class Lt{constructor(t){const e=Int32Array.BYTES_PER_ELEMENT,s=this._maxReadChars+3,i=this._maxWriteChars+2,r=s+i;this._sharedArrayBuffer=void 0===t?new SharedArrayBuffer(r*e):t,this._readArray=new Int32Array(this._sharedArrayBuffer,0,s),void 0===t&&(this._readArray[0]=0,this._readArray[1]=0),this._writeArray=new Int32Array(this._sharedArrayBuffer,s*e,i),void 0!==t&&(this._writeArray[0]=0,this._writeArray[1]=0)}async disable(){this._enabled=!1,this._clear()}async enable(){this._enabled=!0}get enabled(){return this._enabled}utf8ArrayToString(t){return void 0===this._utf8Decoder&&(this._utf8Decoder=new TextDecoder("utf8")),this._utf8Decoder.decode(t)}_clear(){this._readArray[0]=0,this._readArray[1]=0,this._readCount=0}_loadFromSharedArrayBuffer(){const t=Atomics.load(this._readArray,2),e=[];for(let s=0;s<t;s++)e.push(Atomics.load(this._readArray,3+s));return e}_enabled=!1;_sharedArrayBuffer;_maxReadChars=64;_readArray;_readCount=0;_maxWriteChars=256;_writeArray;_utf8Decoder}class Dt extends Lt{outputCallback;constructor(t){super(),this.outputCallback=t}async disable(){if(this._disabling=!0,this._readSentCount!==this._readCount){const t=this._loadFromSharedArrayBuffer();let e="";for(const s of t)e+=String.fromCharCode(s);await this._sendStdinNow(e)}for(;this._readBuffer.length>0;)await this._sendStdinNow(this._readBuffer.shift());this._disabling=!1,super.disable()}dispose(){this._isDisposed||(this._disposing=!0,Atomics.store(this._writeArray,0,999),Atomics.notify(this._writeArray,0),this._isDisposed=!0)}get sharedArrayBuffer(){return this._sharedArrayBuffer}async push(t){this._readBuffer.push(t),this._readBufferCount++,t.length>this._maxReadChars&&console.log(`String '${t}' is too long to buffer`),this._disabling||this._readCount!==this._readSentCount||this._storeInSharedArrayBuffer()}registerSendStdinNow(t){this._sendStdinNow=t}async start(){this._listenForWrite()}async _afterListenWrite(){if(this._disabling)return;let t="",e=!0;do{let s=Atomics.load(this._writeArray,1);e=0===s,e&&(s=this._maxWriteChars);const i=new Int16Array(s);for(let t=0;t<s;t++)i[t]=Atomics.load(this._writeArray,2+t);if(t+=String.fromCharCode(...i),Atomics.store(this._writeArray,0,0),Atomics.notify(this._writeArray,0,1),e&&!this._disposing){const{async:t,value:e}=Atomics.waitAsync(this._writeArray,0,0);t&&await e}}while(e);t.length>0&&!this._disposing&&this.outputCallback(t),this._disposing||this._listenForWrite()}_afterRead(){if(this._readCount=Atomics.load(this._readArray,1),this._readCount!==this._readSentCount)throw new Error("Should not happen");this._readBufferCount>this._readSentCount&&this._storeInSharedArrayBuffer()}_clear(){super._clear(),this._readBuffer=[],this._readBufferCount=0,this._readSentCount=0}_listenForWrite(){const{async:t,value:e}=Atomics.waitAsync(this._writeArray,0,0);t?e.then((()=>this._afterListenWrite())):this._afterListenWrite()}_storeInSharedArrayBuffer(){const t=this._readBuffer.shift();this._readSentCount++;const e=t.length;Atomics.store(this._readArray,2,e);for(let s=0;s<e;s++)Atomics.store(this._readArray,3+s,t.charCodeAt(s));Atomics.store(this._readArray,0,this._readSentCount),Atomics.notify(this._readArray,0,1);const{async:s,value:i}=Atomics.waitAsync(this._readArray,1,this._readCount);s?i.then((()=>this._afterRead())):this._afterRead()}_disposing=!1;_isDisposed=!1;_disabling=!1;_readBuffer=[];_readBufferCount=0;_readSentCount=0;_sendStdinNow}class Mt{packageName;moduleName;outputCallback;constructor(t,e,s){this.packageName=t,this.moduleName=e,this.outputCallback=s}dispose(){this._isDisposed||(this.stop(),this._isDisposed=!0)}get isDisposed(){return this._isDisposed}start(){void 0!==this._intervalId&&this.stop(),this._intervalId=setInterval(this._callback.bind(this),this._delayMs)}stop(){void 0!==this._intervalId&&(clearTimeout(this._intervalId),this._intervalId=void 0,this._callbackCount=0,this._displayed&&this.outputCallback(A+v),this._displayed=!1)}_callback(){if(this._callbackCount<this._initialIgnore);else if(this._displayed){const t=this._dots[(this._callbackCount-this._initialIgnore)%this._dots.length];this.outputCallback(t+w(1))}else{const t=` downloading wasm module '${this.moduleName}'`,e=t.length;this.outputCallback(T+this._dots[0]+t+w(e+1)),this._displayed=!0}this._callbackCount++}_callbackCount=0;_delayMs=100;_dots="â ‡â ‹â ™â ¸â ´â ¦";_initialIgnore=3;_intervalId;_isDisposed=!1;_displayed=!1}class Bt{options;constructor(t){this.options=t,this._bufferedIO=new Dt(t.outputCallback),this._initWorker(t)}async _initWorker(t){this._worker=new Worker(new URL(s.p+s.u(817),s.b),{type:void 0}),this._remote=gt(this._worker);const{mountpoint:e,wasmBaseUrl:i,driveFsBaseUrl:r,initialDirectories:n,initialFiles:a}=t,{sharedArrayBuffer:o}=this._bufferedIO;await this._remote.initialize({color:t.color??!0,mountpoint:e,wasmBaseUrl:i,driveFsBaseUrl:r,sharedArrayBuffer:o,initialDirectories:n,initialFiles:a},bt(this.downloadWasmModuleCallback.bind(this)),bt(this.enableBufferedStdinCallback.bind(this)),bt(this.dispose.bind(this))),this._bufferedIO.registerSendStdinNow(this._remote.input)}dispose(){this._isDisposed||(console.log("Shell.dispose"),this._isDisposed=!0,this._remote=void 0,this._worker.terminate(),this._worker=void 0,void 0!==this._downloadTracker&&(this._downloadTracker.dispose(),this._downloadTracker=void 0),this._bufferedIO.dispose(),this._bufferedIO=void 0,this._disposed.emit())}get disposed(){return this._disposed}downloadWasmModuleCallback(t,e,s){s?(void 0!==this._downloadTracker&&this._downloadTracker.dispose(),this._downloadTracker=new Mt(t,e,this.options.outputCallback),this._downloadTracker.start()):void 0!==this._downloadTracker&&t===this._downloadTracker.packageName&&e===this._downloadTracker.moduleName&&this._downloadTracker.stop()}get isDisposed(){return this._isDisposed}async enableBufferedStdinCallback(t){this.isDisposed||(t?await this._bufferedIO.enable():await this._bufferedIO.disable())}async input(t){this.isDisposed||(this._bufferedIO.enabled?await this._bufferedIO.push(t):await this._remote.input(t))}async setSize(t,e){this.isDisposed||await this._remote.setSize(t,e)}async start(){this.isDisposed||(await this._bufferedIO.start(),await this._remote.start())}_worker;_remote;_bufferedIO;_disposed=new at.Signal(this);_isDisposed=!1;_downloadTracker}}}]);