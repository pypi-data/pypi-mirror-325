
variables:
  PYTHON_DEFAULT_VERSION: "3.13"

stages:
  - test
  - build
  - upload
  - release

unittests:
  stage: test
  image: python:${python_version}
  before_script:
    - pip install --upgrade pip
    - pip install . coverage
  script:
    - coverage run --include="tololib/*" -m unittest discover tests
    - coverage xml
    - coverage report --precision=2
  parallel:
    matrix:
      - python_version: ["3.7", "3.8", "3.9", "3.10", "3.11", "3.12", "3.13"]
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml


code style checks:
  stage: test
  image: python:${PYTHON_DEFAULT_VERSION}
  before_script:
    - pip install pre-commit
  script:
    - pre-commit run --all-files


build packages:
  stage: build
  image: python:${PYTHON_DEFAULT_VERSION}
  rules:
    - if: '$CI_COMMIT_TAG != null'
  before_script:
    - pip install setuptools
  script:
    - python setup.py sdist bdist_wheel
    - ls -lah dist/
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl


upload to PyPI:
  stage: upload
  image: python:${PYTHON_DEFAULT_VERSION}
  rules:
    - if: '$CI_COMMIT_TAG != null'
  before_script:
    - ls -lah dist/
    - pip install twine
  script:
    - twine upload --non-interactive dist/*


create release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:v0.15.0
  rules:
    - if: '$CI_COMMIT_TAG != null'
  script:
    - >
      release-cli create --name $CI_COMMIT_TAG --description "# Changelog$(cat CHANGELOG.md | awk '/## '$CI_COMMIT_TAG'/{flag=1;next}/##/{flag=0}flag')"
      --tag-name $CI_COMMIT_TAG --ref $CI_COMMIT_SHA
      --assets-link "{\"name\": \"Package Files on PyPI\", \"url\": \"https://pypi.org/project/tololib/${CI_COMMIT_TAG:1}/#files\", \"link_type\": \"other\"}"
  needs:
    - upload to PyPI


include:
  - template: SAST.gitlab-ci.yml
