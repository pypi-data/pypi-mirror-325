import win32print
import win32ui
from PIL import ImageWin

"""
References:
https://learn.microsoft.com/en-us/windows/win32/printdocs/documentproperties
https://learn.microsoft.com/en-us/windows/win32/printdocs/advanceddocumentproperties
https://learn.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-devmodew
"""


DM_SIZEOF = 0
DM_UPDATE = 1
DM_COPY = 2
DM_PROMPT = 4
DM_MODIFY = 8
DM_OUT_DEFAULT = DM_UPDATE
DM_OUT_BUFFER = DM_COPY
DM_IN_PROMPT = DM_PROMPT
DM_IN_BUFFER = DM_MODIFY


CAPABILITIES = {
    "DRIVERVERSION": 0,
    "TECHNOLOGY": 2,
    "HORZSIZE": 4,
    "VERTSIZE": 6,
    "HORZRES": 8,
    "VERTRES": 10,
    "BITSPIXEL": 12,
    "PLANES": 14,
    "NUMBRUSHES": 16,
    "NUMPENS": 18,
    "NUMMARKERS": 20,
    "NUMFONTS": 22,
    "NUMCOLORS": 24,
    "PDEVICESIZE": 26,
    "CURVECAPS": 28,
    "LINECAPS": 30,
    "POLYGONALCAPS": 32,
    "TEXTCAPS": 34,
    "CLIPCAPS": 36,
    "RASTERCAPS": 38,  # Bitblt capabilities
    "ASPECTX": 40,  # Length of the X leg
    "ASPECTY": 42,  # Length of the Y leg
    "ASPECTXY": 44,  # Length of the hypotenuse
    "LOGPIXELSX": 88,  # Logical pixels/inch in X
    "LOGPIXELSY": 90,  # Logical pixels/inch in Y
    "SIZEPALETTE": 104,  # Number of entries in physical palette
    "NUMRESERVED": 106,  # Number of reserved entries in palette
    "COLORRES": 108,  # Actual color resolution
    "PHYSICALWIDTH": 110,  # Physical Width in device units
    "PHYSICALHEIGHT": 111,  # Physical Height in device units
    "PHYSICALOFFSETX": 112,  # Physical Printable Area x margin
    "PHYSICALOFFSETY": 113,  # Physical Printable Area y margin
    "SCALINGFACTORX": 114,  # Scaling factor x
    "SCALINGFACTORY": 115,  # Scaling factor y
}

PRINTER_NAME = "SELPHY"
DRIVER_DATA = b'DINU"\x00x\x01\xd4\x03\xc4\x05\x8e.\xdfK\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\r\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00x\x01\x00\x00SMTJ\x00\x00\x00\x00\x10\x00h\x01{\x00B\x007\x001\x006\x006\x001\x00F\x004\x00-\x00A\x004\x00D\x00C\x00-\x004\x003\x00D\x00F\x00-\x00B\x00C\x001\x006\x00-\x003\x009\x00D\x003\x003\x007\x00D\x001\x005\x00A\x009\x005\x00}\x00\x00\x00InputBin\x00FORMSOURCE\x00RESDLL\x00UniresDLL\x00PaperSize\x00JAPANESE_POSTCARD\x00PageBorderless\x00Borderless\x00MediaType\x00Photographic\x00OutputBin\x00FaceUp\x00JobPageOrder\x00Reverse\x00Orientation\x00PORTRAIT\x00PageOutputQuality\x00Normal\x00Collate\x00ON\x00PageScaling\x00Fill\x00Resolution\x00DPI300x300\x00ColorMode\x00Color\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc4\x05\x00\x00V4DM\x01\x00\x00\x00\x00\x00\x00\x00VPPI\xc8\xd0\xf7U(\x00\x00\x00\xac\x05\x00\x00\xb8\x05\x00\x00\x00\x00\x00\x00\x84\x05\x00\x00\t\x00\x00\x00\x0c\x00\x00\x00\xb8\x00\x00\x00n\x00s\x000\x000\x000\x000\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00s\x00c\x00h\x00e\x00m\x00a\x00s\x00.\x00m\x00i\x00c\x00r\x00o\x00s\x00o\x00f\x00t\x00.\x00c\x00o\x00m\x00/\x00w\x00i\x00n\x00d\x00o\x00w\x00s\x00/\x002\x000\x001\x008\x00/\x000\x004\x00/\x00p\x00r\x00i\x00n\x00t\x00i\x00n\x00g\x00/\x00p\x00r\x00i\x00n\x00t\x00s\x00c\x00h\x00e\x00m\x00a\x00k\x00e\x00y\x00w\x00o\x00r\x00d\x00s\x00/\x00I\x00p\x00p\x00\x00\x00\xb4\x00\x00\x00p\x00s\x00f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00s\x00c\x00h\x00e\x00m\x00a\x00s\x00.\x00m\x00i\x00c\x00r\x00o\x00s\x00o\x00f\x00t\x00.\x00c\x00o\x00m\x00/\x00w\x00i\x00n\x00d\x00o\x00w\x00s\x00/\x002\x000\x000\x003\x00/\x000\x008\x00/\x00p\x00r\x00i\x00n\x00t\x00i\x00n\x00g\x00/\x00p\x00r\x00i\x00n\x00t\x00s\x00c\x00h\x00e\x00m\x00a\x00f\x00r\x00a\x00m\x00e\x00w\x00o\x00r\x00k\x00\x00\x00\x00\x00\xb4\x00\x00\x00p\x00s\x00f\x002\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00s\x00c\x00h\x00e\x00m\x00a\x00s\x00.\x00m\x00i\x00c\x00r\x00o\x00s\x00o\x00f\x00t\x00.\x00c\x00o\x00m\x00/\x00w\x00i\x00n\x00d\x00o\x00w\x00s\x00/\x002\x000\x001\x003\x00/\x001\x002\x00/\x00p\x00r\x00i\x00n\x00t\x00i\x00n\x00g\x00/\x00p\x00r\x00i\x00n\x00t\x00s\x00c\x00h\x00e\x00m\x00a\x00f\x00r\x00a\x00m\x00e\x00w\x00o\x00r\x00k\x002\x00\x00\x00\xb0\x00\x00\x00p\x00s\x00k\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00s\x00c\x00h\x00e\x00m\x00a\x00s\x00.\x00m\x00i\x00c\x00r\x00o\x00s\x00o\x00f\x00t\x00.\x00c\x00o\x00m\x00/\x00w\x00i\x00n\x00d\x00o\x00w\x00s\x00/\x002\x000\x000\x003\x00/\x000\x008\x00/\x00p\x00r\x00i\x00n\x00t\x00i\x00n\x00g\x00/\x00p\x00r\x00i\x00n\x00t\x00s\x00c\x00h\x00e\x00m\x00a\x00k\x00e\x00y\x00w\x00o\x00r\x00d\x00s\x00\x00\x00\xb8\x00\x00\x00p\x00s\x00k\x001\x001\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00s\x00c\x00h\x00e\x00m\x00a\x00s\x00.\x00m\x00i\x00c\x00r\x00o\x00s\x00o\x00f\x00t\x00.\x00c\x00o\x00m\x00/\x00w\x00i\x00n\x00d\x00o\x00w\x00s\x00/\x002\x000\x001\x003\x00/\x000\x005\x00/\x00p\x00r\x00i\x00n\x00t\x00i\x00n\x00g\x00/\x00p\x00r\x00i\x00n\x00t\x00s\x00c\x00h\x00e\x00m\x00a\x00k\x00e\x00y\x00w\x00o\x00r\x00d\x00s\x00v\x001\x001\x00\x00\x00\x00\x00\xb8\x00\x00\x00p\x00s\x00k\x001\x002\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00s\x00c\x00h\x00e\x00m\x00a\x00s\x00.\x00m\x00i\x00c\x00r\x00o\x00s\x00o\x00f\x00t\x00.\x00c\x00o\x00m\x00/\x00w\x00i\x00n\x00d\x00o\x00w\x00s\x00/\x002\x000\x001\x003\x00/\x001\x002\x00/\x00p\x00r\x00i\x00n\x00t\x00i\x00n\x00g\x00/\x00p\x00r\x00i\x00n\x00t\x00s\x00c\x00h\x00e\x00m\x00a\x00k\x00e\x00y\x00w\x00o\x00r\x00d\x00s\x00v\x001\x002\x00\x00\x00\x00\x00h\x00\x00\x00x\x00m\x00l\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00w\x00w\x00w\x00.\x00w\x003\x00.\x00o\x00r\x00g\x00/\x00X\x00M\x00L\x00/\x001\x009\x009\x008\x00/\x00n\x00a\x00m\x00e\x00s\x00p\x00a\x00c\x00e\x00\x00\x00\x00\x00`\x00\x00\x00x\x00s\x00d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00w\x00w\x00w\x00.\x00w\x003\x00.\x00o\x00r\x00g\x00/\x002\x000\x000\x001\x00/\x00X\x00M\x00L\x00S\x00c\x00h\x00e\x00m\x00a\x00\x00\x00\x00\x00p\x00\x00\x00x\x00s\x00i\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00h\x00t\x00t\x00p\x00:\x00/\x00/\x00w\x00w\x00w\x00.\x00w\x003\x00.\x00o\x00r\x00g\x00/\x002\x000\x000\x001\x00/\x00X\x00M\x00L\x00S\x00c\x00h\x00e\x00m\x00a\x00-\x00i\x00n\x00s\x00t\x00a\x00n\x00c\x00e\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x0c\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x0c\x00\x00\x00'


def list_printers():
    return [p[2] for p in win32print.EnumPrinters(win32print.PRINTER_ENUM_LOCAL)]


def get_printer_name():
    for p in win32print.EnumPrinters(win32print.PRINTER_ENUM_LOCAL):
        if PRINTER_NAME in p[2].upper():
            return p[2]
    return None


def get_printer_capabilities(printer_name):
    context = win32ui.CreateDC()
    context.CreatePrinterDC(printer_name)
    capabilities = dict()
    for k,v in CAPABILITIES.items():
        c = context.GetDeviceCaps(v)
        capabilities[k] = c
    context.DeleteDC()
    return capabilities


def configure_printer(printer_name):
    printer = win32print.OpenPrinter(printer_name, {'DesiredAccess': win32print.PRINTER_ALL_ACCESS})
    level = 2
    properties = win32print.GetPrinter(printer, level)
    dev_mode_output = properties["pDevMode"]

    # Get current properties
    win32print.DocumentProperties(0, printer, printer_name,
                                  dev_mode_output,
                                  None,
                                  DM_OUT_BUFFER)
    # Update
    dev_mode_output.Fields = 33664771
    dev_mode_output.FormName = "Japanese Postcard"
    dev_mode_output.Orientation = 2
    dev_mode_output.Position_x = 2818050
    dev_mode_output.DriverData = DRIVER_DATA

    # Set new properties
    win32print.DocumentProperties(0, printer, printer_name,
                                  dev_mode_output,
                                  dev_mode_output,
                                  DM_IN_BUFFER | DM_OUT_BUFFER)
    return printer  # call `win32print.ClosePrinter(printer)` when done


def print_image(printer_name, print_document_name, image):
    context = win32ui.CreateDC()
    context.CreatePrinterDC(printer_name)
    handle = context.GetHandleOutput()

    context.StartDoc(print_document_name)
    context.StartPage()

    dib = ImageWin.Dib(image)
    box = (0, 0, image.width, image.height)
    dib.draw(handle, box)

    context.EndPage()
    context.EndDoc()
    context.DeleteDC()

